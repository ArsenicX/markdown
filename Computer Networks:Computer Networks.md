IXP：互联网交换点 Internet eXchange Point



# 概述

## 性能指标

1. 速率（车速）：1M=10<sup>6</sup>。表示速度时，以10为底

2. 带宽（路宽）：1M=2<sup>20</sup>。表示存储大小时，以2为底

3. 吞吐量（b/s）：在单位时间内**实际**通过某个网络的数据量

4. 时延
    发送时延 = 传输数据 / 带宽。可以靠提升带宽而降低
    传播时延 = 物理距离 / 传输速率。传输速率取决于通信线路的材料
    “光纤速度更快”是指信号在光纤信道中有更高的**发送速度**，而非**传播速度**。实际上，光在光纤中的传播速度为 2×10<sup>8</sup> m/s，略慢于电磁波在铜线中的速度 2.3×10<sup>8</sup> m/s

5. 时延带宽积(时延×带宽)：有多少数据在路上

6. 信道利用率
并非越高越好，根据排队论的理论：`当前时延 D = 空闲时延 D0 / (1 - 信道利用率 U )`，当利用率增大时，该信道引起的时延也就迅速增加；可以类比于公路上车辆越多，公路的利用率就越高，但是不可避免地就会造成堵车。因此一些大的主干网的 ISP 会将利用率控制在 50% 以下

## 体系结构

1. OSI 参考模型对网络排错的意义：

   1. 查看链接状态，发送和接收的数据包数值 -> **物理层故障**
   2. Mac地址冲突；ADSL(非对称数字用户线路)欠费；两端的接口网速没有协商一致；计算机连接到其它VLAN(虚拟互联网)中；VLAN 错误 -> **数据链路层故障**
   3. IP地址、子网掩码、网关错误 -> **网络层故障**
   4. 应用程序配置问题 -> **应用层故障**

2. 网络排错过程

   检查网络连接、ping 网关 & DNS  & 域名 & 域名+端口

# 物理层

|信号怎么在有线/无线介质上传输？|
|-|
## 通信专业补充知识

### 码元

数字信号中横轴的一个单位格就是一个码元。一个码元可以携带多个信息量，比如携带 3 个信息量，就可以从 000 到 111 表示8位

### 基带信号

来自信源的信号，例如计算机输出的代表文字、图像、文件的数字信号

### 调制

基带(数字)信号往往包含了很多低频成分，然而这种低频成分并不能被许多信道（长距离）传输，所以我们需要对基带信号进行`调制`

> 就好像是这种数字信号不能被放行一样，那我们就需要通过调制改变一下基带信号，让他能被放行。调制有两种方法，分别是基带调制和带通调制。
>
> 基带调制仅仅只是给数字信号换了身行头，他还是数字信号
>
> 带通调制则是给他做了整形，样子完全大变，变成了模拟信号

#### 基带调制/编码

仅变换基带信号的波形：数字信号 -> 数字信号

虽然是调制，但是因为前后还是数字信号没变，所以人们通常称其为编码

![](1585289186730.jpg)

不归零制：如果有太多的 0 或 1，就会导致收到的信号是很长的平线，接收端不易区分间隔，即没有自同步能力

归零制：有了自同步能力，但是频率过高，每个码元都有2次波动

（差分）曼彻斯特编码：基于上述做了改进。目前常用差分曼彻斯特编码

#### 带通调制

使用`载波`进行调制，把信号频率范围搬移到高的频段传输：数字信号 -> 带通信号

![](1585289426781.jpg)

步骤：基带信号 -> `载波`调制后的带通信号 -> 波峰和之前形状一样 -> 还原

![image-20220905134038592](image-20220905134038592.jpg)

### 调制解调编码解码总结

A 向 B 发了个图片：

图片（模拟信号）→信源编码器（转换为数字信号，A->D）→调制器（转换为模拟信号，D->A）→长距离传输介质→解调器（转换为数字信号，A->D）→信源解码器（转换为模拟信号，D->A，并输出成图片）

### 数字信号来源

![image-20220905134734596](image-20220905134734596.jpg)

### 信道极限容量

从概念上讲，限制码元在信道上传输速率的因素有 2 个：

1. 码间串扰

   ![](1585296810369.jpg)
   传输速率过高会导致出现码间串扰，面对这种现象，Nyquist 推导出了**奈氏准则**，给出了在理想条件下(无噪声/干扰/失真)，码元传输速率的上限

2. 信噪比(dB)：

   信息的平均功率和噪声的平均功率之比，计作 S/N。单位**可以**为 dB

   > S/N 这玩意儿给我整晕了，大概可能是这个意思？
   >
   > 通常信息的平均功率和噪声的平均功率之比为 S/N 信噪比
   >
   > 但是如果想用 dB 作为单位，就需要用公式过一遍：
   >
   > `信噪比(dB) = 10 * log10(S/N) `
   >
   >
   > ⚠️：
   >
   > 若信噪比 S/N 为 30，就可以直接带入香农公式中使用
   >
   > 若信噪比 S/N 为 30dB，就需要先用上面公式求出来 S/N，才能用香农
   
   可以依靠「提高频带宽度」、「提高码元传输速率」和「每个码元携带更多的比特信息量」提高信噪比
   

1948 年 Shannon 推导出的**香农公式**，指出了信道的极限信息传输速率C
   `C (bits/s) = 信道的带宽W * log2(1 + S/N) `

奈氏准则和香农公式的应用范围

![](1585297117204.jpg)

## 信道复用技术

| 我们希望传更快更多的数据，但速度受限于硬件技术，那能不能传的多呢？ |
| ------------------------------------------------------------ |

- 数字信号：常用时分复用（没有数据传输时的空隙会造成浪费）、统计时分复用（需要给不同用户的数据加装地址信息以供接收端能够识别该信息该传给谁，扩大了开销；倘若所有用户大量长期发送数据，则 STDM 将无法应付过来，内部缓存会溢出）

  ![时分复用](1585303266106.jpg)

  

  ![统计时分复用](1585303478581.jpg)

- 模拟信号：常用频分复用

  ![](1587813139647.jpg)

- 波信号（光）：常用波分复用（等同于频分复用）

- 无线信号：码分复用

## 带宽接入技术

带宽接入可以分为有线接入和无线接入，无线接入放在[最后](#无线网)

而有线接入又可以分为3种方式

1. 非对称数字用户链路 ADSL
    电话信号的频带在300-3400Hz之间，但是电话线可以通过的频率实际上却超过1MHz，因此可以使用电话线，把原来没有利用的高频谱段留给用户上网使用


  ![](1585315008062.jpg)

  因为通常用户在上网时都是下载居多，上传较少，因此ADSL的下行带宽要远大于上行，“非对称”这个名词就是这么来的

  采用方案：DMT技术。采用频分复用的方法，把40kHz以上一直到1.1MHz的高频谱划分为许多子信道，其中25个子信道用于上行信道，249个子信道用于下行信道

  ![](1587813910344.jpg)

  原理：
  ![](1587815528808.jpg)
  ![](1587815533210.jpg)

  以前，如图1，本地电话局一根线直接拉到家里面的电话机上

  现在，如图2，ISP-区域宽带接一根线并入到电话线（用户线)上，然后送到居民家中，再被分给电话用和电脑用

  但是怎么把网线并入电话线呢？然后又要怎么分离呢？这就需要`电话分离器`了，一个放在宽带和电话线合并的接口处用于网线的并入，另一个放在家中用于二者的分离

  同时由于宽带需要调制解调，这就需要`ADSL调制解调器`了，分别放在电话分离器之前和之后使用

> 原文：![](1585357505659.jpg) 


|既然能走电话线上网，那就也能用电视线上网吧。|
|-|

2. 光纤同轴混合网HFC (Hybrid Fiber Coax)：

  HFC网是在目前覆盖面很广的有线电视网 CATV 的基础上开发的一种居民宽带接入网。除了可传送电视节目外，还提供电话、数据和其他宽带交互型业务。

  方案：现有的 CATV 网是树形拓扑结构的同轴电缆网络，它采用模拟技术的频分复用对电视节目进行单向传输。而 HFC 网则需要对 CATV 网进行改造。

  原理：HFC 网将原 CATV 网中的同轴电缆主干部分改换为光纤，使用模拟光纤技术（在模拟光纤中采用光的振幅调制 AM，这比使用数字光纤更为经济）。模拟光纤从头端连接到光纤结点
  ![](1587815739186.jpg)
  为了要使现有的模拟电视机能接收数字电视信号，还需要一个`机顶盒`连接在同轴电缆和电视机之间

  为了用户能够利用HFC网接入到互联网以及在上行信道中传送交互数字电视所需的信息，还需要增加一个HFC 网的调制解调器，又称为`电缆调制解调器(cable modem)`

  但是，由图可对比看出，ADSL方案中，用户计算机连接的电话线是用户独享的，因此传输的最高数据率是确定的；而HFC方案中一个光纤结点连接着通常是500户人家，如果大量用户同时上网，则每个用户的实际速率则会降低的非常严重

3. 光纤 FTTx 技术
![](1585366175213.jpg)

# 数据链路层

| 信号可以在无线/有线介质上传输了，接下来要研究信号怎么被两端接收、识别并传输。 【设备/交换机/路由器 <- - -> 设备/交换机/路由器】<br/>数据链路层只涉及同一个介质上的设备通信，并没有跨网段 |
| ------------------------------------------------------------ |

> 物理层：转发器/集线器/中继器/放大器
> 链路层：网桥/交换机
> 网络层：路由器

## 三个基本问题

数据链路层有很多种协议，但有三个基本问题是共同的

1. 封装成帧：给帧添加什么标记符

2. 透明传输：解决数据内容和标记符重名的问题

3. 差错检测：检测**比特**是否在传输过程中出错

   常用手段是 FCS (Frame Check Sequence)，即给帧添加一段帧检验序列

   FCS 序列通常是由 CRC (Cyclic Redundancy Check) 检错技术算出

   不可靠传输：通常数据链路层不管传输差错（帧丢失、帧重复、帧失序）



数据链路层中使用的信道主要有两种类型：**点对点信道** 和 **广播信道**

## 点对点：PPP

### 封装成帧

![](1585380100279.jpg)

- 首部的第一个字段和尾部的第二个字段都是标志字段 F (Flag)，7E的二进制为 01111110，标志着一个帧的开始或者结束
- 首部中的地址字段和控制字段，即图中的 A 和 C，暂时还没有具体定义，即没有任何信息量
- 首部的第四个字段是2字节的协议，不同的数有不同的含义。比如当协议字段为 0x0021 时 PPP 帧的信息字段为 IP 数据报；为 0xC021 时，信息字段是 PPP 链路控制协议 LCP 的数据
- 信息部份的长度不超过 1500 字节
- 尾部的第一个字段是使用 CRC 的帧检验序列 FCS

### 透明传输

当 PPP 用在 SONET/SDH 链路时，通常是同步传输（一连串的比特发送），此时使用零比特填充法

- 只要有连续的5个1，就填入一个0，使得确保不会出现6个0

当 PPP 使用异步传输时，使用 0x7D 转义（字节填充法），并规定：

- 0x7E -> (0x7D, 0x5E)

- 0x7D -> (0x7D, 0x5D)

- 若出现 ASCII 码的控制字符（即数值小于 0x20 的字符），则在该字符前面要加入一个 0x7D 字节，同时将该字符的编码加以改变

  如 0x03 -> (0x7D, 0x23)

### 工作过程（v3:8-9）

1. 首先通过 LCP 配置请求
2. 认证阶段：PAP / CHAP
3. 配置确认协商阶段：IPCP（NCP）

## 广播信道：CSMA/CD

> CSMA/CD 是总线以太网使用的协议，现在常用的是以太网交换机,，虽然不需要 CSMA/CD 协议了，但是还是要学习一下

### MAC 地址

|广播的话，怎么确定发给谁呢 -> MAC 地址|
|-|

MAC 地址是在出厂时就被嵌入到适配器 ROM 中的，如果一台计算机安装多个适配器，那他就会有多个MAC地址

共 6 个字节。前 3 个字节为组织唯一标识符OUI（ Organizationally Unique Identifier），需要向IEEE购买。后 3 个字节称为扩展标识符（ extended identifier），由厂家自行指派，只要自行保证没有重复即可

不过，IEEE 考虑到可能有人不愿意向 IEEE 购买 OUI。为此，IEEE 把地址字段第 1 字节的最低第二位规定为 G 位，表示 Global/ Local。

GL 位为 0 时是**全球管理**，即在全球没有重复地址，厂商购买的 OUI 都属于全球管理。G/L 位为 1 时是**本地管理**，这时用户可任意分配网络上的地址。采用2字节地址字段时全都是本地管理。但通常来说以太网几乎不理会这个 G/L 位。

|可是当主机收到信号时，他怎么知道是给他发的呢？|
|-|

适配器可以通过过滤功能排除掉不是发给自己的。这里“发给自己的帧”包括以下三种帧：

1. 单播 (unicast) 帧，即收到的帧的MAC地址与本站的硬件地址相同
2. 广播 (broadcast) 帧，即发送给本局域网上所有站点的帧，目标地址全1）
3. 多播 (multicast) 帧，即发送给本局域网上一部分站点的帧

适配器可以开启混杂模式以窃听发送给其他目标的帧

IEEE 规定地址字段第一字节的最低位为 IG 位 (Individual / Group)。当 IG 位为 0 时，地址字段表示一个单个站地址。当 IG 位为 1 时表示组地址，用来进行多播。

所以由 IEEE 分配的的址字段前三个字节中，第一个字节的最后一位为 I/G 位，而第二个字节为 G/L 位，能够剩余分配的只有 22 位，即总共可用的只有 46（22+24）位。不过 2<sup>46</sup> 超过了70万亿，所以还不用担心地址耗尽的问题

### CSMA/CD 协议前提知识

CSMA/CD 协议有以下要点

- 载波监听：发送前和发送中都要检测信道。发送前是为了获得发送权；发送中是为了检测有无其他信号和自己产生了碰撞，即碰撞检测
- 碰撞检测：当检测到信号电压摆动值超过一定的阈值时，就认为总线上至少有两个站同时在发送数据，并产生了碰撞

#### 碰撞检测

假设单程端到端的传播时延为 τ，0 时刻 A 向 B 发送数据，δ 时刻 B 开始向 A 发送数据，可从下图得，**最迟**要经过 2τ 时才能知道发生了碰撞

![](1587817663080.jpg)

由此将这个 2τ 称为**争用期(contention period) / 碰撞窗囗（collision window)**。只有通过争用期的“考验”，才说明这次发送肯定不会出现碰撞

> 电磁波在 1km 电缆的传播时延为 5μs（应当记住）
>
> 同时也可看出使用 CSMA/CD 协议的以太网是半双工通信模式

协议规定，如果听到了别人在发送数据，也就说明发生了碰撞，那就都别发了，都先等会儿。那等多久呢？

![](1585413575106.jpg)
![](1585411897837.jpg)

那就又有个问题了，假如我发送的数据很少，就一个比特，发送完成之后我就不监听信道了，以至于发生了碰撞我也没听到。不知道发生了碰撞，我也就不会重传发生冲突的帧了，这可咋办？
为了解决这个问题，以太网规定最短帧长为 64 字节，即 512 bit。如果要发送的数据非常少，那么必须加入一些填充字节，使帧长不小于 64 字节。

因此，以太网如果发送了 64 字节都无碰撞，那么后续就一定不会冲突

也因此可以得出，如果发生碰撞，则这时己经发送出去的数据最多也就是64字节。因此，长度小于 64 字节的帧都是由于冲突而异常中止的无效帧，只要收到了这种无效帧，就应当立即将其丢弃。

以太网的争用期被定为 51.2 μs，考虑到了许多因素，比如转发器自身的时延、强化碰撞的干扰信号

[补充：为什么 10Mbit/s 以太网取 51.2 μs 为争用期长度？](https://www.zhihu.com/question/454044228)

#### 强化碰撞

当发送数据的站一旦发现发生了碰撞时，除了立即停止发送数据外，还要再继续发送 32 比特或 48 比特的**人为干扰信号**

![](1587818584372.jpg)

#### 帧间最小间隔

以太网还规定了**帧间最小间隔**为 9.6μs，相当于 96 比特时间。这样做是为了使刚刚收到数据帧的站的接收缓存来得及清理，做好接收下一帧的准备。

#### 步骤

根据以上所讨论的，可以把 CSMA/CD 协议的要点归纳如下：

1. 准备发送：适配器从网络层获得一个分组，加上以太网的首部和尾部（见后），组成以太网帧，放入适配器的缓存中。发送前必须先检测信道。

2. 检测信道：若检测到信道忙，则继续检测直到信道空闲。若检测到信道空闲，并在 96 比特时间（帧间最小间隔）内信道依旧空闲就发送这个帧

3. 在发送过程中仍不停地检测信道，即网络适配器要边发送边监听。这里只有两种可能性：

   - 发送成功：在争用期内一直未检测到碰撞。这个帧肯定能够发送成功。发送完毕后，其他什么也不做。然后回到（1)。

   - 发送失败：在争用期内检测到碰撞。这时停止发送数据，并发送人为干扰信号。适配器此时执行指数退避算法，等待 r 倍 512 比特时间后，返回到（2），继续检测信道。但若重传达16次仍不能成功，则停止重传而向上报错。

以太网每发送完一帧，要把已发送的帧暂时保留一下。这样如果在争用期内发生碰撞，就要推迟一段时间把这个暂时保留的帧重传一次。

### MAC 格式

由五个字段组成：

- 前两个字段分别为 6 字节长的目的地址和源地址字段。

- 第三个字段是 2 字节的类型字段，用来标志上一层使用的是什么协议，以便把收到的 MAC 帧的数据上交给上一层的这个协议。例如，当类型字段的值是 0x0800 时，就表示上层使用的是IP数据报

- 第四个字段是数据字段，其长度在 46 到 1500 字节之间（46字节 = 64 字节 (最小长度 ) - 18 字节(首部和尾部) ）

  长度小于 46 字节时，MAC 子层就会在数据字段的后面加入一个整数字节的填充字段。当上层使用 IP 协议时，其首部有一个“总长度”字段。因此 IP 层可以通过“总长度”字段把填充字段丢弃

- 最后一个字段是 4 字节的帧检验序列 FCS（使用CRC检验）

![image-20220906140854913](image-20220906140854913.jpg)

可看出实际传送要多 8 字节。这是为了接收端能实现位同步。它由两个字段构成：

- 第一个字段是7个字节的前同步码（1和0交替码），它的作用是使接收端的适配器在接收MAC帧时能够迅速调整其时钟频率，实现位同步
- 第二个字段是帧开始定界符，定义为 l0101011

以太网在传送帧时，各帧之间还必须有一定的间隙。且因为以太网使用的是曼彻斯特编码，也就是说只要接收端的电压不再变化了，就说明接收结束了，所以以太网**不需要使用帧结束定界符**，也不需要使用字节插入来保证透明传输。

注意：MAC 帧的 FCS 字段的检验范围并不包括前同步码和帧开始定界符。而且，在使用 SONET/SDH 进行同步传输时则不需要用前同步码，因为在同步传输时收发双方的位同步总是一直保持着的。

当数据字段的长度小于 46 字节时，MAC 子层就会在数据字段的后面加入一个整数字节的填充字段，以保证以太网的MAC帧长不小于 64 字节。在后面章节我们将会学到，当上层使用 IP 协议时，其首部就有一个“总长度”字段。因此，“总长度”加上填充字段的长度，应当等于MAC帧数据字段的长度。例如，当IP数据报的总长度为42字节时，填充字段共有4字节。当MAC帧把46字节的数据上交给I层后，IP层就把其中最后4字节的填充字段丢弃。

## 拓展以太网

### 在物理层面拓展

使用光纤或多个集线器
![](1587883488216.jpg)

![](1587884753458.jpg)

但是这也带来了一些缺点：

1. 在互连之前，每个集线器连接的网络是一个独立的碰撞域（或称为冲突域），即在任一时刻，在每一个碰撞域中只能有一个站在发送数据。若每一个系的以太网的最大吞吐量是10 Mbit/s，则三个系总的最大吞吐量共有30Mbis。而当三个系的以太网通过集线器互连起来后就把三个碰撞域变成一个碰撞域（范围扩大到三个系），而这时的最大吞吐量仍然是一个系的吞吐量10Mbis。这就是说，当某个系的两个站在通信时所传送的数据会通过所有的集线器进行转发，使得其他系的内部在这时都不能通信（一发送数据就会碰撞）。
2. 如果不同的系使用不同的以太网技术（如数据率不同），那么就不可能用集线器将它们互连起来。假设一个系使用10 Mbit/s的适配器，而另外两个系使用10/100Mbts的适配器，那么用集线器连接起来后，大家都只能工作在10Mbis的速率。

### 在数据链路层拓展

最初是网桥（ bridge），但由于网桥的接口数量少且数据传输速度慢，交换式集线器（ switching hub）很快就淘汰了网桥。交换式集线器常称为以太网交换机（ switch）或第二层交换机（L2 switch）（强调工作在第二层）

#### 以太网交换机

1. 以太网交换机实质上就是一个多接口的网桥，通常都有十几个或更多的接口，并且一般都工作在**全双工方式**。

1. 以太网交换机还具有**并行性**，即能同时连通多对接口，使多对主机能同时通信，而网桥只能一次分析和转发一个帧。相互通信的主机都是**独占传输媒体，无碰撞地传输数据**。

   > 对于传统的10Mbts的共享式以太网，若共有10个用户，则每个用户占有的平均带宽只有1Mbis。若使用以太网交换机来连接这些主机，虽然在每个接口到主机的带宽还是10 Mbit/s，但由于一个用户在通信时是独占而不是和其他网络用户共享传输媒体的带宽，因此对于拥有10个接口的交换机的总容量则为100Mbis。这正是交换机的最大优点。

1. 以太网交换机的**接口还有存储器**，能在输出端口繁忙时把到来的帧进行缓存。因此，如果连接在以太网交换机上的两台主机，同时向另一台主机发送帧，那么当这台主机的接口繁忙时，发送帧的这两台主机的接口会把收到的帧暂存一下，以后再发送出去。

   > 虽然许多以太网交换机对收到的帧采用存储转发方式进行转发，但也有一些交换机采用直通（ cut-through）的交换方式。直通交换不必把整个数据帧先缓存后再进行处理，而是在接收数据帧的同时就立即按数据帧的目的MAC地址决定该帧的转发接口，因而提高了帧的转发速度。
   >
   > 若在这种交换机内部采用基于硬件的交叉矩阵，交换时延就非常小
   >
   > 直通交换的一个缺点是它不检査差错就直接将帧转发出去，因此有可能也将一些无效帧转发给其他的站。在某些情况下，仍需要采用基于软件的存储转发方式进行交换，例如，当需要进行线路速率匹配、协议转换或差错检测时。现在有的厂商已生产出能支持两种交换方式的以太网交换机。

1. 以太网交换机是一种**即插即用**设备，其内部的帧交换表（又称为地址表）是通过**自学习算法**自动建立起来的。以太网交换机由于使用了专用的交换结构芯片，用硬件转发，其转发速率要比使用软件转发的网桥快很多

   > ![](1587888656376.jpg)全篇引用教材，没啥好说的：
   > ![](1587888656376.jpg)
   > ![](1587888677321.jpg)
### 虚拟局域网 VLAN v3:22-24

VLAN 协议允许在以太网的帧格式中插入一个 4 字节的标识符，称为 VLAN 标记，用来指明发送该帧的计算机属于哪一个虚拟局域网。插入 VLAN 标记得出的帧称为 802.1Q 帧。显然如果还使用原来的以太网帧格式，就无法区分是否划分了 VLAN

![](1587891924095.jpg)

VLAN 标记字段的长度是 4 字节，插入在以太网 MAC 帧的源地址字段和类型字段之间。VLAN 标记的前两个字节总是设置为 0x8100，即10000010000

当数据链路层检测到 MAC 帧的源地址字段后面的两个字节的值是 0x8100 时，就知道现在插入了 4 字节的 VLAN 标记。于是就接着检查后面两个字节的内容。在后面的两个字节中，前3位是用户优先级字段，接着的一位是规范格式指示符CFI（ Canonical format Indicator），最后的12位是该虚拟局域网 vLAN 标识符 vID（ VLAN ID），它唯一地标志了这个以太网帧属于哪一个VLAN。

由于用于VLAN的以太网帧的首部增加了4个字节，因此以太网的最大帧长从原来的1518字节（1500字节的数据加上18字节的首部）变为1522字节。

补充阅读：[VLAN 基础知识](https://zhuanlan.zhihu.com/p/35616289)

# 网络层

| 在数据链路层解决了同一个网络中的通信，网络层用于解决不同网络中的通信 |
| ------------------------------------------------------------ |

## IP 地址

用 IP 地址最后一位除以 2/4/8 得到余数，即为原 IP 对应二进制的末 1/2/3 位数

1. 169.254.x.x：保留地址
2. 0.0.0.0：自己
3. 私有网段：
   1. A 类：10.0.0.0 - 10.255.255.255（10.0.0.0/8）
   2. B 类：172.16.0.0 - 172.31.255.255（172.16.0.0/12）
   3. C 类：192.168.0.0 - 192.168.255.255（192.168.0.0/16）

![](1587898490388.jpg)

## 子网 & 超网

快速计算方法：https://www.bilibili.com/video/BV1G64y1z7qg

![Image](Image.JPEG)

## 路由选择协议

| IP 地址只写着发件人和收件人地址，但是中间该给哪些中转站呢？ |
| ----------------------------------------------------------- |

通过路由表便可以查到从当前 ip 到目标 ip 要经过的下一跳的地址。路由表中还有其他字段，但是最重要的便是 (目标网络地址, 下一跳的地址)

不同区域的情况不同，将一个大的 ISP 划分为一个自治系统 AS (autonomous system)，AS 内部可以选择适合自己的路由选择协议（称为内部网关协议，常用 [RIP、OSPF：v5:11](https://blog.csdn.net/kxbdys/article/details/122585500)），AS  和 AS 之间的路由选择协议称为外部网关协议（常用 BGP-4：v5:21）

当匹配到多条结果的时候，通常采用**最长前缀匹配方法**

当路由表信息越来越多，路由表的查找时间会非常大。目前常用二叉线索查找法

![Screen Shot 2022-09-07 at 16.42.48](Scr.jpg)

另外，不同的设备也会对不同协议得出的路由信息进行优先级排序

直连路由是指路由器通电后自动发现的与自己相连的设备的地址；静态路由是指手动指定的地址。路由器还可以设置默认路由，指如果找不到可转发的地址，就发往的目标地址，通常用 0.0.0.0 表示

![Screen Shot 2022-09-07 at 16.45.03](Screen Shot 2022-09-07 at 16.45.03.jpg)

## 网际协议 IP

与 IP 协议配套使用的还有三个协议：

- 地址解析协议ARP（ Address resolution protocol）
- 网际控制报文协议ICMP（ Internet Control Message Protocol）
- 网际组管理协议IGMP（ nternet Group Management Protocol）
- ~~逆地址解析协议RARP（ Reverse address resolution protocol）已淘汰~~

![](1587895336725.jpg)

ARP 在最下面，因为 IP 经常要使用这个协议。ICMP 和 IGMP 在上部，因为它们要使用 IP 协议

### 地址解析协议 ARP

| 根据路由表知道了下一跳的 ip 地址，那怎么获取到其对应的 mac 地址呢？ |
|-|


![](1587906561441.jpg)
![](1587906596027.jpg)

当主机 A 欲向本局域网上的某个主机 B 发送 IP 数据报时，就先在其 ARP 高速缓存中查看有无主机 B 的 IP 地址。如有，就查出其对应的硬件地址写入 MAC 帧。如无，则可能是主机 B 才入网，也可能是主机 A 刚通电等等，其高速缓存还是空的。这种情况下主机 A 自动运行ARP，然后按以下步骤找出主机B的硬件地址。

![](1587906989784.jpg)

1. ARP 在本局域网内广播发送一个 ARP 请求分组。

2. 在本局域网上的所有主机上运行的 ARP 进程都收到此 ARP 请求分组。

3. 主机 B 的 IP 地址与 ARP 请求分组中要查询的 IP 地址一致，就收下这个 ARP 请求分组，并向主机 A 发送 ARP 响应分组，同时在这个 ARP 响应分组中写入自己的硬件地址。由于其余的所有主机的 IP 地址都与 ARP 请求分组中要查询的 IP 地址不一致，因此都不理睬这个 ARP 请求分组。

   为了减少网络上的通信量，主机 A 在发送其 ARP 请求分组时，会把自己 IP 地址到硬件地址的映射写入 ARP 请求分组。当主机 B 收到 A 的 ARP 请求分组时，会把主机 A 的这一地址映射写入自己的 ARP 高速缓存中

   注意：虽然 ARP 请求分组是广播发送的，但 ARP 响应分组是普通的单播，即从一个源地址发送到一个目的地址

4. 主机 A 收到主机 B 的 ARP 响应分组后，就在其 ARP 高速缓存中写入主机 B 的 IP 地址到硬件地址的映射。

另外，ARP 对保存在高速缓存中的每一个映射地址项目都设置生存时间（例如，10~20分钟）。凡超过生存时间的项目就从高速缓存中删除掉。已避免某些设备网络适配器突然坏掉，更换之后硬件地址发生改变的情况

![](/Users/swong/Library/Mobile Documents/com~apple~CloudDocs/win ⬌ mac/ArsenicX.github.io/md/Computer Networks/1587907356268.jpg)

注意，ARP 是解决**同一个局域网**上的主机或路由器的 IP 地址和硬件地址的映射问题。如果所要找的主机和源主机不在同一个局域网上，比如主机 H1 发送给 H2，就需要通过与主机 H1 连接在同一个局域网上的路由器 R1 来转发。因此主机 H1 需要把路由器 R1 的 IP 地址 IP3 解析为硬件地址 HA3，把 IP 数据报传送到路由器R1。然后 R1 从转发表找出了下一跳路由器 R2 同时使用 ARP 解析出 R2 的硬件地址 HA5。于是 IP 数据报按照硬件地址 HA5 转发到路由器 R2 。路由器 R2 在转发这个 IP 数据报时用类似方法解析出目的主机 H2 的硬件地址 HA2，使 IP 数据报最终交付主机 H2 。

因此我们可以归纳出ARP的使用场景:

- 主机 -> 本网络上的另一个主机。用 ARP 找到目的主机的硬件地址
- 主机 -> 另一个网络上的另一个主机。用 ARP 找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成。
- 路由器 -> 本网络上的一个主机。用 ARP 找到目的主机的硬件地址。
- 路由器 -> 另一个网络上的一个主机。用 ARP 找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成。

### [国际控制报文协议 ICMP](https://baike.baidu.com/item/ICMP/572452)

用于主机/路由器报告差错情况和提供有关异常情况的报告

ICMP 位于网络层的上端，但并不是高层协议。因为 ICMP 的报文是作为数据部分装在 IP 数据报中的。ICMP 报文的协议字段为 1

- 常见的询问报文：

  回送请求和回答，用于测试目的站是否可达和了解状态

  用于时钟同步和时间测量

- 常见的差错报告：

  终点不可达、时间超过、参数问题、重定向

#### 应用举例

- tracert、pathping：跟踪数据包路径
- ping：诊断链路故障并定位到是哪一段

### 多播

IP 地址中的 D 类地址是组播地址，而 D  类地址的前四位为 1110，即组播地址范围为 224.0.0.0 - 239.255.255.255。但注意，有些地址被指派为了永久地址，不能随意用

![Screen Shot 2022-09-07 at 18.19.52](Screen Shot 2022-09-07 at 18.19.52.jpg)

#### 在局域网内多播

|目标地址的 MAC 地址怎么写|
|-|

互联网号码指派管理局 IANA 拥有的以太网地址块的高 24 位为 00-00-5E，因此 TCP/IP 协议使用的以大网多播地址块的范围是从 00-00-5E-00-00-00 到 00-00-5E-FF-FF-FF

在 [这里](#MAC 地址) 已经知道 IG 位为 1 时表示组地址，用来多播，这种多播地址数占 IANA 分配到的地址数的一半。因此 IANA 拥有的以太网多播地址的范围是从 01-00-5E-00-00-00到 01-00-5E-7F-FF-FF

不难看出，在每一个地址中，只有 23 位可用作多播。而 D 类 IP 地址有  28 位，可见这 28 位中的前 5 位不能用来构成以太网硬件地址

![Screen Shot 2022-09-07 at 18.33.31](Screen Shot 2022-09-07 at 18.33.31.jpg)

例如，IP 多播地址 224.128.64.32（即 E0-80-40-20）和另一个 IP 多播地址 224.0.64.32（即 E0-00-40-20）转换成以太网的硬件多播地址都是 01-00-5E-00-40-20。由于多播 IP 地址与以太网硬件地址的映射不唯一，所以收到多播数据报的主机需要在 IP 层过滤掉目标 IP 不是自己的数据报

#### 在互联网上多播

![090718514639_0Screen Shot 2022-09-07 at 18.49.53](090718514639_0Screen Shot 2022-09-07 at 18.49.53.jpg)

## 路由器结构

整个结构可以划分为两大部分：路由选择 + 分组转发

![](Screen Shot 2022-09-07 at 16.29.38.jpg)

### 路由选择

根据选定的路由选择协议构造、维护路由表

### 分组转发

> 多数分组交换机的机制都是**存储转发传输**，即数据从发送端发往路由器时，路由器要先全部缓存下来；全部缓存完毕后再发送给下一目的地
>
> 假设当前链路为 A - R - B，数据在链路上传输的延迟为 n，那么数据从 A 到 B 的延迟就为 2n，因为数据相当于在 R 处中转了一下；而如果不是存储转发传输机制的话，那延迟就会是 n

如果接收到的分组是路由器之间交换路由信息的分组（RIP、OSPF等），就将其交给路由选择部分中的路由选择处理机；

如果接收到的是数据分组就按照分组首部中的目的地查找转发表，然后经过交换结构到达合适的输出端口

![Screen Shot 2022-09-07 at 16.35.28](Screen Shot 2022-09-07 at 16.35.28.jpg)

![Screen Shot 2022-09-07 at 16.35.33](Screen Shot 2022-09-07 at 16.35.33.jpg)

#### 常见交换结构

![Screen Shot 2022-09-07 at 16.36.28](Screen Shot 2022-09-07 at 16.36.28.jpg)

## [IP 数据报格式](https://blog.csdn.net/ZBraveHeart/article/details/123791830)

> 并不是二维的，而是因为太长了所以这样写

![](1587907693184.jpg)

## VPN 虚拟专用网（Virtual Private Network）

已知道有以下三种私有网段：

1. A 类：10.0.0.0 - 10.255.255.255（10.0.0.0/8）
2. B 类：172.16.0.0 - 172.31.255.255（172.16.0.0/12）
3. C 类：192.168.0.0 - 192.168.255.255（192.168.0.0/16）

在公司/机构/家庭内部的机器要互相通信的话，并不需要每台设备都拥有一个公网 IP 地址，只需要拥有一个唯一的私有网段的 IP 即可。这样机构内部的机器在互联网上显示的 IP 地址统一为路由器的地址，可以节省 IP 地址。

此时内部的网络也叫做专用网（Private Network），内部设备可以互相通信，也可以访问互联网，但是互联网的设备不能访问到内部的设备（只能访问到对外暴露的路由器）

如果不同国家/地区的设备想要访问对方的设备，可以考虑租用电信公司的专线，或者采用虚拟专用网的方法，相当于在两个地区之间打通一条隧道，模拟设备均在同一个内部网中

具体操作：【源地址｜目标地址｜数据部分】

![WX20220908-094421@2x](WX20220908-094421@2x.jpg)

1. X 欲发送数据包 【 X_IP｜ Y_IP｜ … 】 给 Y

2. 数据报交给路由器 X_Router 后，会将原数据合并、加密并封装成新的数据部分，并添加首尾

   【X_Router_IP｜Y_Router_IP｜【 X_IP｜ Y_IP｜ … 】】

3. 因为路由器的 IP 是在互联网上可见的，所以数据会通过互联网传送给 Y 路由器，然后把内部数据取出并解密，恢复为【 X_IP｜ Y_IP｜ … 】

4. 返回同理

## 网络地址转换 NAT Network Address Translation

在访问互联网设备的时候，为了节省全球 IP 地址，可以让内部的设备轮流使用路由器的全球 IP。

![WX20220908-100908@2x](WX20220908-100908@2x.jpg)

假设路由器有两个全球 IP：172.38.1.5 和 172.38.1.6。内部设备访问互联网时，路由器通过内部的转换表，将数据报的源地址（192.168.0.3）改写为自己的全球地址（172.38.1.5），就可以使得内部设备访问到互联网。接收数据时同理照表改回。

### 网络地址与端口号转换 NAPT Network Address And Port Translation

传统的 NAT 如果有 n 个全球 IP 的话，则最多只支持 n 个内网设备同步访问互联网，如果要加设备，要么是轮流使用，要么是多添加全球 IP ，可是这不符合节省全球 IP 地址的目标。所以 NAPT 技术使用了端口号来区分内网设备。原理相通

![WX20220908-101227@2x](WX20220908-101227@2x.jpg)

有些批评声：首先 NAPT 会改变数据报的源/目标 IP 地址；其次端口号属于运输层，在网络层查看/转换端口号不符合网络协议分层而治的概念

> 虽然没搞懂为什么不使用和 VPN 同理的技术，明明也能解决

## IPV6

将用新的 NDP 协议囊括了 IPV4 的 ARP，IGMP 协议更新为 MLD 协议，ICMP 协议更新为 ICMPv6

![WX20220908-113350@2x](WX20220908-113350@2x.jpg)

### IP 地址

- 未指明地址 `::` 或 `::/128`：类似于 IPV4 的 0.0.0.0 表示自己
- 环回地址 `::1` 或 `::1/128`：类似于 IPV4 的 127.0.0.1
- 多播地址 `11111111` 或 `FF00::/8`
- 本地链路单播地址 `11111111010` 或 `FE80::/10`：本地私有网段地址

### 目标地址

- 单播

- 多播

- 任播：终点是一组计算机中的其中一个，通常是最近的那个

  作用：京东在全国部署了 n 台服务器，IPV6 地址都一样。用户访问的时候会自动挑选最近的一台；如果服务器故障了也会自动连接到其他服务器

### 配置 IPV6 地址：v7:5-7

### 配置静态动态路由协议：v7:8-10

### [数据报格式](https://www.jianshu.com/p/fc51baef675f)

![WX20220908-143258@2x](WX20220908-143258@2x.jpg)

### IPV4 -> IPV6

1. 双协议栈

   在遇到不支持 IPV6 的主机/路由器时，由中间支持的设备将数据报转为 IPV4 的版本。但是缺点是首部某些字段可能无法恢复，如下图的流标号

   ![WX20220908-160016@2x](WX20220908-160016@2x.jpg)

2. 隧道技术

   类似于 VPN 技术，遇到不支持 IPV6 的设备时将 IPV6 的全部内容作为数据部分，然后加上 IPV4 的首部进行发送。IPV4 首部协议字段设置为 41 即表明数据部分内容为 IPV6 数据报

   ![WX20220908-160355@2x](WX20220908-160355@2x.jpg)

## MPLS 多协议标记交换

### 思路 & 步骤：

传统流程是分组每到达一个路由器都要查找路由表，并按照最长前缀匹配原则找到下一跳的 IP 地址。当网络很大的时候，查找大量路由表会花费大量时间，遇到突发问题还会导致分组丢失、延迟增大等情况

MPLS 的特点是在每个数据包进入 LSR（标记交换路由器）的时候，给数据报打上 MPLS 标记，然后对打了标记的数据报用硬件进行转发

此时不再需要上升到第三层去查找路由表，仅仅在第二层链路层就能实现转发。牺牲了一点标记的占用空间，但是换来了更快的转发速度

![090816384127_02](090816384127_02.jpg)

### 转发等价类 FEC

> 概念没看懂，但是可以实现负载均衡

H<sub>1</sub>，H<sub>2</sub> 分别向H<sub>3</sub>，H<sub>4</sub> 发送大量数据，传统的路由协议只会选择 A->B->C 的最短路径，但是 MPLS 可以实现负载均衡

![WX20220908-164902@2x](WX20220908-164902@2x.jpg)

### 首部的格式及位置：略

# 运输层

> 网络层实现了不同网络的主机的通信，但数据应该传给哪个应用/进程呢？

运输层协议与应用层协议的关系：

通常传输层协议加一个端口号来表示一个应用层协议

![WX20220908-171943@2x](WX20220908-171943@2x.jpg)

## 端口

作用：用以区分服务/进程

端口号：是一个 16 位的数字，即可允许 65535 个不同的端口号。

- 熟知端口号：0 - 1023，被分配给了最重要的程序

  ![WX20220908-175256@2x](WX20220908-175256@2x.jpg)

- 登记端口号：1024 - 49151，分配给了无熟知端口号的程序

  比如远程桌面协议 RDP 的端口为 TCP 3389

- 客户/短暂端口号：49152 - 65535，客户进程使用时临时分配，用完收回

网安：更改默认端口的话，可以让黑客无法得知对应端口提供的是什么服务，也就不知道该用什么方式攻击

## UDP

面向报文：把上层传下来的报文直接转发

场景：向DNS服务器请求解析域名、语音聊天、广播多播 …

作用：在 IP 层上只加了很少的一点功能：通过加端口号实现复用分用、差错检测

[首部格式 & 差错检测](https://blog.csdn.net/a1451516/article/details/114178524)（在计算检验和的时候会临时增加 12 个字节的伪首部）

如果接收方收到的报文中的目的端口号不存在，就由 ICMP 发送 “端口不可达” 的差错报文。这也正是 traceroute 测试链路的逻辑

## TCP

面向字节流：把上层传下来的报文拆分成数据块再转发；TCP 可以一次性把多个数据块打包并转发，这取决于接收方给出的窗口值和当前网络堵塞程度

连接：每一条连接被两个端点（套接字）确定
	TCP 连接 ::= {socket<sub>1</sub>, socket<sub>2</sub>} = {(IP<sub>1</sub>:port<sub>1</sub>), (IP<sub>2</sub>:port<sub>2</sub>)}
同一个 IP 地址/端口号可以有多个不同的 TCP 连接

### 可靠传输

#### 停止等待协议

> 并不使用这个协议

思路：每发一个数据报就等对方回一个确认；超过一定时间没有收到确认就重发

![WX20220909-102649@2x](WX20220909-102649@2x.jpg)

重点：

1. 每发送完一个数据报后要再保留一段时间，收到确认之后才能丢
2. 分组和确认分组要编号，以确认哪个被发出了，哪个被确认了
3. 超时器的时间要比平均传输时间略长些

缺点：信道利用率低，发一个等一个太慢了

#### 连续 ARQ 协议

##### 思路

> 相当于停止等待协议的改进

发一组等一个：发送 1-10 报文，然后等待回复。回复 10 就说明全部收到，开始发送 11-20；回复 3 就说明 123 收到后面丢失，开始发送 4-13。

就好像一个滑动框一样勾选到当前该发送的报文编号

需要说明的是，TCP 协议规定接收方可以自己决定，在合适的时候发送确认。可以是收到几个之后再确认，也可以是在有数据要发送给发送方的时候顺便带上确认信息。但是最长不应该超过 0.5s

##### 缓存

发送方和接收方都有缓存，而且要大得很

发送方的缓存用来放置需要发送的数据，和已发送但还未收到确认的数据

接收方的缓存用来放置已收到但还未被上层处理的数据，和未按序到达的数据

![WX20220909-105929@2x](WX20220909-105929@2x.jpg)

当接收方收到了 32、33 之后会将其暂存起来，等收到 31 后可一并交付给主机

##### SACK

现在已经有了可以支持**选择确认 SACK**的机制：接收方可在 TCP 首部写入**边界**以表明还收到了其中某些块

比如首部中还写了 (5,6) (8,10)，那发送方下次就会单独发送 4、7 和新的 11-13

要使用 SACK 的话，需要在建立 TCP 连接的时候就在首部加入**允许SACK**选项。同时因为可变长度最大 40 字节，减去两个字节分别指明「这是 SACK 选项」和「这个选项要占用多少字节」，指明一个边界需要 4 字节，成对使用也就是 8 字节。(40-2)/8 = 4，即最多可以报告确认收到了 4 个分块

##### 超时重传协议

![090911265850_01](090911265850_01.jpg)

### [首部格式](https://www.cnblogs.com/YXBLOGXYY/p/14266324.html)

### 流量控制

即窗口大小的设置，接收方让发送方发的慢一些别太快

#### 持续计时器

考虑一种情况，接收方说自己没窗口了，此时发送方就会等待。过了一会接收方发送数据说自己有窗口了，但是这个信息丢失了，发送方就会一直等着了

为了避免这种死锁情况，TCP 设置了一个持续计时器。只要接收方说自己没有窗口之后，发送方就开始计时，每过一段时间发送一个一字节探测报文段等待回复

TCP 规定，即使接收方无窗口，也要接受零窗口探测报文段、确认报文段、携带紧急数据的报文段

### 效率

在流量控制的前提下，发送方要以什么频率节奏发送呢？目前广泛使用 Nagle 算法

发送端先把要发送的数据放到发送缓存中，然后把第一个数据字节先发出去，当收到第一个字节的确认后，再把剩下部分组装成一个报文段并发送。或到达的数据已达到窗口大小的一半，或达到最大长度时，就立即发送一个报文段

还有个问题会影响效率 —— 糊涂窗口综合症。表现为接收方无窗口，发送方在等待。此时接收方腾出一个字节之后通知发送方，发送方就会发送一个字节，然后接收方又无窗口了，往复循环。发送的数据仅为 1 字节，但是加上各种首尾部之后占 41 字节，效率低下。这种情况通常出现在接收方的应用程序处理数据太慢

解决方法是让接收方等一段时间，等到接收缓存已经足够容纳一个最长的报文段之后，或已有一半空闲的空间，再通知发送方发送。

### 拥塞控制

![WX20220909-155611@2x](WX20220909-155611@2x.jpg)

#### 通常有四种算法

- 慢开始

  发一个，确认一个，然后发两个，确认两个，然后发4、8、16…N 个，直到 N 等于 1-2 个发送方的最大报文段长度。当发生堵塞时，N 赋为 1，然后重新1、2、4、8 … 发送

  ![WX20220909-155648@2x](WX20220909-155648@2x.jpg)

- 拥塞避免

  随机设置 ssthresh 为堵塞门限值，在 N 快接近 ssthresh 时，不再成倍上涨，而是以此加 1。当发生堵塞时，ssthresh 赋为 N 的一半，N 赋为 1，然后重新1、2、4、8 … 发送（❺ 是 快恢复）

  ![WX20220909-160238@2x](WX20220909-160238@2x.jpg)

- 快重传

  但是存在一种误杀的情况，即没有发生堵塞，只是普通的丢包，但被判别为堵塞。快重传算法要求接收方收到报文之后立即发送确认请求，即使是失序的数据

  假设接收方收到了 1，2，没有收到 3，然后收到了 4。此时接收方便知道 3 丢失了，于是会在已经发送了 1，2 的确认的基础上，再立刻多发 3 个关于 2 的确认，用于提醒发送方 2 后面的数据包丢失了

  ![WX20220909-160751@2x](WX20220909-160751@2x.jpg)

- 快恢复

  和拥塞避免类似，只不过当发生堵塞时，N 赋为自己的一半并重新发送

#### 总流程

![WX20220909-161317@2x](WX20220909-161317@2x.jpg)

发送方窗口上限 = Min [ 接收方指定的窗口值 rwnd, cwnd ]

#### 主动队列管理 AQM

上文的管理策略都是在运输层考虑的，但是还有一种情况是路由器处理数据太慢，导致不得不丢弃缓存来的数据。AQM 的思想是让路由器不要在发生拥堵时才丢弃数据包，而是提前感知。如果即将拥堵，则主动丢弃一些数据包，迫使某些倒霉的 TCP 链路降低发送速度

### 连接管理

连接三次握手

- 能连吗？
- 可以
- 好

![WX20220909-163233@2x](WX20220909-163233@2x.jpg)

断开四次握手

- 分开吧
- 我收拾一下
- 分吧
- 好

![WX20220909-163405@2x](WX20220909-163405@2x.jpg)

等待 2s 是以防自己说的「好」服务器没收到，那样会导致服务器不敢释放 TCP

总结：

![WX20220909-163745@2x](WX20220909-163745@2x.jpg)

# 应用层

## DNS

主机向本地域名服务器查询的方式一般是递归查询：如果本地域名服务器不知道被查询域名的 IP 地址，就会自己去问别人

本地域名服务器向根域名服务器查询的方式一般是迭代查询：如果根域名服务器不知道被查询域名的 IP 地址，就会告诉本地域名服务器，你可以去问 XXX

### 应用场景 v9:3

1. 在内网配置一个域名服务 ArsenicX.com 并部署给一台主机 192.168.10.11，然后在内网设置一个 DNS 服务器，将其他域名请求信息都正常处理，只有 ArsenicX.com 返回 192.168.10.11，可以实现本地创建了一个网页服务。
2. 如果公司/机构内会经常访问某些域名，则可在本地创建一个 DNS 服务器，把该域名及其 IP 写到本地，这样就省去了每次解析的过程

## DHCP

自动获得 IP、DNS、网关

## 邮件

浏览器向邮件服务器发送/接收邮件的时候用的是 http 协议

仅在不同邮件服务器之间通讯时，用的才是 smtp/pop3/imap

# 网络安全

> K：密钥；SK<sub>x</sub>：x 的私钥；PK<sub>x</sub>：x 的公钥；假设数据由 A 发送至 B

1. 签名-防伪造：A 用 SK<sub>A</sub> 加密，B 用 PK<sub>A</sub> 解密

2. 加密-防偷听 ：假设 B 接收。用 PK<sub>B</sub> 加密，接收方用 SK<sub>B</sub> 解密。只有 B 才能解出。非对称加密安全+不可否认，对称加密效率高，二者结合起来：

   对大文件用对称密钥加密（效率高），然后把对称密钥用公钥加密（对称密钥体积小，效率也不会浪费太多）。然后把加密后的文件和对称密钥发给接收方。接收方用私钥解密对称密钥，再用对称密钥解密大文件

   ![WX20220909-184712@2x](WX20220909-184712@2x.jpg)

   

3. hash-防篡改：MD5，SHA-1

   报文鉴别：对每段报文进行签名加密

   ![WX20220911-172103@2x](WX20220911-172103@2x.jpg)

   实体鉴别：在接入时间内对通信的对方实体只验证一次

中间人攻击：

![WX20220911-173029@2x](WX20220911-173029@2x.jpg)

为了防止中间人攻击，就需要对密钥有个更为安全的分配

目前来说对称密钥的分配通常使用 Kerberos 方法；
非对称密钥的分配依靠 CA（Certification Authority） 下发证书：v10:18

## [网络层安全协议 IPsec](https://zhuanlan.zhihu.com/p/532300682)

## 运输层安全协议 TLS/SSL v10:19

1. TLS/SSL 位于应用层和运输层之间
2. http 端口为 80，https 为 443

# 无线网

## 分类

可分为两类：有固定基础设施的；移动自组网络

有固定基础设施的（Wi-Fi）：

- 标准：IEEE 802.11
- 中心：接入点 AP（即路由器）
- MAC 协议：CSMA/CA
- 安装 AP 时候需要分配一个不超过32字节的 SSID（无线的名字）和信道

移动自组网络：

- 场景：在战场、抢险救灾等不适合预先固定接入点的场合可以通过临时组建移动自组网络进行通信
- 子集 - 无线传感器网络：洪水预报、病房监测、矿洞监测、敌情监控等

## IEEE 802.11

> 物理层：复杂，略

### MAC 层

因为无线电波传播距离有限，且易受到障碍影响，导致无法实现 CSMA/CD 碰撞检测，也容易遇到下图两种问题 - 隐蔽站问题 & 暴露站问题：

![WX20220912-171949@2x](WX20220912-171949@2x.jpg)

因此改用 CSMA/CA 协议

![091223463917_01](091223463917_01.jpg)

## 蜂窝移动网络 cell

前面学到，通信双方通过 IP 地址来确定对方地址。对于移动设备来说，在移动过程中，IP 地址就一定会发生变化，如果在对方 IP 变化后还能准确地发给对方呢？

- 永久地址/归属地址：移动设备的 IP。永远不变
- 归属网络：移动设备初次连接到的网络。永远不变
- 归属代理：归属网络的路由器
- 被访网络：移动设备移动到另一地点接入的网络
- 外地代理：另一地点网络的路由器

一种方法是**直接路由选择**：

![WX20220912-234826@2x](WX20220912-234826@2x.jpg)
